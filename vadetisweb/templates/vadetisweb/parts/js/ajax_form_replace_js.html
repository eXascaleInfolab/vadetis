<!-- BEGIN AJAX FORM JS -->
<script type="text/javascript">
    function updateTimeRange() {
        if ($("#id_time_range").length > 0) {
            var highchart = $('#highcharts_container').highcharts();
            var time_range = $('#id_time_range').val();
            var extremes_x = highchart.xAxis[0].getExtremes();
            var range = {};

            if (time_range === 'as selected in chart') {
                range.min = Math.round(extremes_x.min);
                range.max = Math.round(extremes_x.max);
            } else {
                range.min = Math.round(extremes_x.dataMin);
                range.max = Math.round(extremes_x.dataMax);
            }

            if ($("#rangeStart").length > 0) {
                $("#rangeStart").replaceWith(
                    $('<input />').attr('type', 'hidden')
                        .attr('id', "id_range_start")
                        .attr('name', "range_start")
                        .attr('value', range.min));
            } else {
                $('<input />').attr('type', 'hidden')
                    .attr('id', "id_range_start")
                    .attr('name', "range_start")
                    .attr('value', range.min)
                    .appendTo('#anomaly_detection_form');
            }

            if ($("#rangeEnd").length > 0) {
                $("#rangeEnd").replaceWith(
                    $('<input />').attr('type', 'hidden')
                        .attr('id', "id_range_end")
                        .attr('name', "range_end")
                        .attr('value', range.max));
            } else {
                $('<input />').attr('type', 'hidden')
                    .attr('id', "id_range_end")
                    .attr('name', "range_end")
                    .attr('value', range.max)
                    .appendTo('#anomaly_detection_form');
            }
        }
    };

    $('#{{ formid }}').on('submit', function (event) {
        event.preventDefault();
        updateTimeRange();
        clear_form_errors("{{ formid }}");
        clear_messages();
        $.post({
            url: $(this).attr('action'){% if format %}+'?format={{ format }}'{% endif %},
            data: new FormData(this),
            type: $(this).attr('method'),
            enctype: $(this).attr('enctype'),
            processData: false,
            contentType: false,
            success: function (data, status, xhr) {
                if (xhr.getResponseHeader('Location')) {
                    window.location = xhr.getResponseHeader('Location');
                }
                var new_form_inner = $(data).filter('#{{ formid }}').html();
                $('#{{ formid }}').html(new_form_inner);
                if (data.responseJSON !== undefined && data.responseJSON.hasOwnProperty('messages')) {
                    print_messages(data.responseJSON.messages);
                }
            },
            error: function (data, status, xhr) {
                console.error("Sending asynchronous failed");
                if (data.responseJSON !== undefined && data.responseJSON.hasOwnProperty('messages')) {
                    print_messages(data.responseJSON.messages);
                }
                if (data.responseJSON !== undefined && data.responseJSON.hasOwnProperty('form_errors')) {
                    print_form_errors(data.responseJSON.form_errors);
                }
            }
        });
    });
</script>
<!-- END AJAX FORM JS -->
