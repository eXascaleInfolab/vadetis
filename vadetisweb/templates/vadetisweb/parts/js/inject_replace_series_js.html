<!-- BEGIN AJAX FORM JS -->
<script type="text/javascript">
    $('#{{ formid }}').on('submit', function (event) {
        event.preventDefault();
        clearFormErrors("{{ formid }}");
        clearMessages();
        var highchart = $('#highcharts_container').highcharts(), csrftoken = Cookies.get('csrftoken'), formData = new FormData(this);

        formData.append('normal_range', JSON.stringify(ionSliderRangeValue("normal_range")));
        formData.append('anomaly_range', JSON.stringify(ionSliderRangeValue("anomaly_range")));

        highchart.showLoading();

        $.ajax({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            },
            url: $(this).attr('action'){% if format %}+'?format={{ format }}'{% endif %},
            data: formData,
            type: $(this).attr('method'),
            enctype: $(this).attr('enctype'),
            processData: false,
            contentType: false,
            success: function (data, status, xhr) {
                handleMessages(data);

                highchart.hideLoading();
                var series_data_json = data['series'];
                setSeriesData(highchart, series_data_json);
            },
            error: function (data, status, xhr) {
                printMessages([{'message': "Request failed"}], "error-request");
                handleMessages(data);
                highchart.hideLoading();
            }
        });
    });
</script>
<!-- END AJAX FORM JS -->
